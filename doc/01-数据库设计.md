# 百科Web应用 - 数据库设计文档

## 1. 概述

本文档详细描述了百科Web应用的数据库结构设计，参考萌娘百科的功能特点，包含用户管理、文章编辑、评论系统、分类管理等核心功能。

## 2. 数据库选型

- **主数据库**: PostgreSQL 15+ (支持JSONB、全文搜索、事务等)
- **缓存数据库**: Redis 7+ (用于会话、缓存、实时数据)
- **文件存储**: 本地文件系统 + 对象存储（可选）

## 3. 核心数据表设计

### 3.1 用户表 (users)

存储用户基本信息和认证数据。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 用户ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名（唯一） |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 邮箱（唯一） |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值（bcrypt） |
| nickname | VARCHAR(100) | | 昵称/显示名称 |
| avatar_url | VARCHAR(500) | | 头像URL |
| bio | TEXT | | 个人简介 |
| role | VARCHAR(20) | NOT NULL, DEFAULT 'user' | 角色：user, editor, admin, sysadmin |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'active' | 状态：active, banned, deleted |
| email_verified | BOOLEAN | DEFAULT FALSE | 邮箱是否验证 |
| last_login_at | TIMESTAMP | | 最后登录时间 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_users_username` ON users(username)
- `idx_users_email` ON users(email)
- `idx_users_role` ON users(role)
- `idx_users_status` ON users(status)

### 3.2 文章表 (articles)

存储文章/条目的基本信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 文章ID |
| title | VARCHAR(500) | NOT NULL | 文章标题 |
| slug | VARCHAR(500) | UNIQUE, NOT NULL | URL友好标识符 |
| content | TEXT | NOT NULL | 文章内容（Markdown格式） |
| content_html | TEXT | | 渲染后的HTML内容 |
| summary | TEXT | | 文章摘要 |
| cover_image_url | VARCHAR(500) | | 封面图片URL |
| author_id | BIGINT | NOT NULL, FK -> users(id) | 创建者ID |
| editor_id | BIGINT | FK -> users(id) | 最后编辑者ID |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'draft' | 状态：draft, published, archived, deleted |
| view_count | INTEGER | DEFAULT 0 | 浏览次数 |
| like_count | INTEGER | DEFAULT 0 | 点赞数 |
| comment_count | INTEGER | DEFAULT 0 | 评论数 |
| edit_count | INTEGER | DEFAULT 0 | 编辑次数 |
| is_featured | BOOLEAN | DEFAULT FALSE | 是否精选 |
| is_locked | BOOLEAN | DEFAULT FALSE | 是否锁定（禁止编辑） |
| published_at | TIMESTAMP | | 发布时间 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_articles_slug` ON articles(slug)
- `idx_articles_author_id` ON articles(author_id)
- `idx_articles_status` ON articles(status)
- `idx_articles_published_at` ON articles(published_at DESC)
- `idx_articles_view_count` ON articles(view_count DESC)
- `idx_articles_title_gin` ON articles USING GIN(to_tsvector('jiebacfg', title)) -- 全文搜索

### 3.3 文章版本表 (article_versions)

存储文章的历史版本，支持版本控制和回滚。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 版本ID |
| article_id | BIGINT | NOT NULL, FK -> articles(id) | 文章ID |
| version_number | INTEGER | NOT NULL | 版本号 |
| title | VARCHAR(500) | NOT NULL | 标题 |
| content | TEXT | NOT NULL | 内容 |
| content_html | TEXT | | 渲染后的HTML |
| editor_id | BIGINT | NOT NULL, FK -> users(id) | 编辑者ID |
| edit_reason | VARCHAR(500) | | 编辑原因/备注 |
| change_summary | TEXT | | 变更摘要 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_article_versions_article_id` ON article_versions(article_id, version_number DESC)
- `idx_article_versions_editor_id` ON article_versions(editor_id)

**唯一约束**:
- UNIQUE(article_id, version_number)

### 3.4 分类表 (categories)

存储文章分类信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 分类ID |
| name | VARCHAR(100) | NOT NULL | 分类名称 |
| slug | VARCHAR(100) | UNIQUE, NOT NULL | URL标识符 |
| description | TEXT | | 分类描述 |
| parent_id | BIGINT | FK -> categories(id) | 父分类ID（支持多级分类） |
| icon_url | VARCHAR(500) | | 图标URL |
| sort_order | INTEGER | DEFAULT 0 | 排序顺序 |
| article_count | INTEGER | DEFAULT 0 | 文章数量 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_categories_slug` ON categories(slug)
- `idx_categories_parent_id` ON categories(parent_id)
- `idx_categories_sort_order` ON categories(sort_order)

### 3.5 文章分类关联表 (article_categories)

文章与分类的多对多关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 关联ID |
| article_id | BIGINT | NOT NULL, FK -> articles(id) | 文章ID |
| category_id | BIGINT | NOT NULL, FK -> categories(id) | 分类ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_article_categories_article_id` ON article_categories(article_id)
- `idx_article_categories_category_id` ON article_categories(category_id)
- UNIQUE(article_id, category_id)

### 3.6 标签表 (tags)

存储标签信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 标签ID |
| name | VARCHAR(50) | UNIQUE, NOT NULL | 标签名称 |
| slug | VARCHAR(50) | UNIQUE, NOT NULL | URL标识符 |
| description | TEXT | | 标签描述 |
| color | VARCHAR(20) | | 标签颜色（CSS颜色值） |
| article_count | INTEGER | DEFAULT 0 | 使用次数 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_tags_slug` ON tags(slug)
- `idx_tags_name` ON tags(name)

### 3.7 文章标签关联表 (article_tags)

文章与标签的多对多关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 关联ID |
| article_id | BIGINT | NOT NULL, FK -> articles(id) | 文章ID |
| tag_id | BIGINT | NOT NULL, FK -> tags(id) | 标签ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_article_tags_article_id` ON article_tags(article_id)
- `idx_article_tags_tag_id` ON article_tags(tag_id)
- UNIQUE(article_id, tag_id)

### 3.8 评论表 (comments)

存储评论信息，支持多级回复。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 评论ID |
| article_id | BIGINT | NOT NULL, FK -> articles(id) | 文章ID |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 评论者ID |
| parent_id | BIGINT | FK -> comments(id) | 父评论ID（回复） |
| content | TEXT | NOT NULL | 评论内容 |
| content_html | TEXT | | 渲染后的HTML |
| like_count | INTEGER | DEFAULT 0 | 点赞数 |
| reply_count | INTEGER | DEFAULT 0 | 回复数 |
| status | VARCHAR(20) | DEFAULT 'published' | 状态：published, deleted, hidden |
| ip_address | VARCHAR(45) | | IP地址（用于审核） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_comments_article_id` ON comments(article_id, created_at DESC)
- `idx_comments_user_id` ON comments(user_id)
- `idx_comments_parent_id` ON comments(parent_id)
- `idx_comments_status` ON comments(status)

### 3.9 点赞表 (likes)

存储用户点赞记录（文章和评论）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 点赞ID |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 用户ID |
| target_type | VARCHAR(20) | NOT NULL | 目标类型：article, comment |
| target_id | BIGINT | NOT NULL | 目标ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_likes_user_target` ON likes(user_id, target_type, target_id)
- `idx_likes_target` ON likes(target_type, target_id)
- UNIQUE(user_id, target_type, target_id)

### 3.10 文件表 (files)

存储上传的文件信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 文件ID |
| filename | VARCHAR(255) | NOT NULL | 原始文件名 |
| stored_filename | VARCHAR(255) | NOT NULL | 存储文件名 |
| file_path | VARCHAR(500) | NOT NULL | 文件路径 |
| file_url | VARCHAR(500) | NOT NULL | 文件访问URL |
| file_size | BIGINT | NOT NULL | 文件大小（字节） |
| mime_type | VARCHAR(100) | NOT NULL | MIME类型 |
| file_type | VARCHAR(20) | NOT NULL | 文件类型：image, video, document, other |
| uploader_id | BIGINT | NOT NULL, FK -> users(id) | 上传者ID |
| usage_count | INTEGER | DEFAULT 0 | 使用次数 |
| is_public | BOOLEAN | DEFAULT TRUE | 是否公开 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_files_uploader_id` ON files(uploader_id)
- `idx_files_file_type` ON files(file_type)
- `idx_files_created_at` ON files(created_at DESC)

### 3.10.1 文章图片表 (article_images)

存储文章内容中使用的图片信息，用于图片管理和清理。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 图片记录ID |
| article_id | BIGINT | NOT NULL, FK -> articles(id) | 文章ID |
| image_url | VARCHAR(500) | NOT NULL | 图片URL（相对路径或绝对路径） |
| image_path | VARCHAR(500) | | 服务器上的文件路径 |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| mime_type | VARCHAR(100) | | MIME类型（如 image/jpeg） |
| width | INTEGER | | 图片宽度（像素） |
| height | INTEGER | | 图片高度（像素） |
| alt | VARCHAR(500) | | 图片描述（Alt文本） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMP | | 软删除时间 |

**索引**:
- `idx_article_images_article_id` ON article_images(article_id)
- `idx_article_images_image_url` ON article_images(image_url)
- `idx_article_images_deleted_at` ON article_images(deleted_at)

**说明**:
- 该表用于追踪文章内容中使用的所有图片
- 支持软删除，便于后续的图片清理和管理
- 当文章内容更新时，系统会自动提取图片URL并更新该表
- 可以用于统计图片使用情况、清理未使用的图片等

### 3.11 用户关注表 (user_follows)

用户之间的关注关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 关注ID |
| follower_id | BIGINT | NOT NULL, FK -> users(id) | 关注者ID |
| following_id | BIGINT | NOT NULL, FK -> users(id) | 被关注者ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_user_follows_follower` ON user_follows(follower_id)
- `idx_user_follows_following` ON user_follows(following_id)
- UNIQUE(follower_id, following_id)
- CHECK(follower_id != following_id)

### 3.12 通知表 (notifications)

存储用户通知信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 通知ID |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 接收用户ID |
| type | VARCHAR(50) | NOT NULL | 通知类型：comment, like, follow, mention, system |
| title | VARCHAR(200) | NOT NULL | 通知标题 |
| content | TEXT | | 通知内容 |
| target_type | VARCHAR(20) | | 目标类型：article, comment, user |
| target_id | BIGINT | | 目标ID |
| is_read | BOOLEAN | DEFAULT FALSE | 是否已读 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_notifications_user_id` ON notifications(user_id, is_read, created_at DESC)
- `idx_notifications_type` ON notifications(type)

### 3.13 审核日志表 (moderation_logs)

存储内容审核和操作日志。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 日志ID |
| moderator_id | BIGINT | NOT NULL, FK -> users(id) | 审核员ID |
| action | VARCHAR(50) | NOT NULL | 操作类型：approve, reject, delete, ban, unban |
| target_type | VARCHAR(20) | NOT NULL | 目标类型：article, comment, user |
| target_id | BIGINT | NOT NULL | 目标ID |
| reason | TEXT | | 操作原因 |
| metadata | JSONB | | 额外元数据 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_moderation_logs_moderator_id` ON moderation_logs(moderator_id)
- `idx_moderation_logs_target` ON moderation_logs(target_type, target_id)
- `idx_moderation_logs_created_at` ON moderation_logs(created_at DESC)

### 3.14 搜索历史表 (search_history)

存储用户搜索历史（可选，用于分析）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 历史ID |
| user_id | BIGINT | FK -> users(id) | 用户ID（匿名用户为NULL） |
| keyword | VARCHAR(200) | NOT NULL | 搜索关键词 |
| result_count | INTEGER | | 结果数量 |
| ip_address | VARCHAR(45) | | IP地址 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_search_history_user_id` ON search_history(user_id, created_at DESC)
- `idx_search_history_keyword` ON search_history(keyword)
- `idx_search_history_created_at` ON search_history(created_at DESC)

## 4. 数据库关系图

```
users (1) ──< (N) articles
users (1) ──< (N) comments
users (1) ──< (N) article_versions
users (1) ──< (N) files
users (1) ──< (N) moderation_logs

articles (1) ──< (N) article_versions
articles (1) ──< (N) comments
articles (1) ──< (N) article_images
articles (N) >──< (N) categories (通过 article_categories)
articles (N) >──< (N) tags (通过 article_tags)
articles (1) ──< (N) likes

comments (1) ──< (N) comments (parent_id)
comments (1) ──< (N) likes

categories (1) ──< (N) categories (parent_id)

users (1) >──< (N) users (通过 user_follows)
```

## 5. 数据库约束和规则

### 5.1 外键约束
- 所有外键都设置 `ON DELETE CASCADE` 或 `ON DELETE SET NULL`（根据业务逻辑）
- 用户删除时，其创建的文章、评论等需要根据业务规则处理

### 5.2 数据完整性
- 使用数据库触发器自动更新计数字段（如 article_count, comment_count）
- 使用数据库触发器自动更新 updated_at 字段
- 使用 CHECK 约束确保数据有效性（如 status 字段的值）

### 5.3 性能优化
- 为常用查询字段创建索引
- 使用 PostgreSQL 的 GIN 索引支持全文搜索
- 定期执行 VACUUM 和 ANALYZE
- 考虑分区表（如按时间分区 article_versions）

## 6. 数据迁移策略

### 6.1 版本控制
- 使用数据库迁移工具（如 Alembic, Flyway）管理数据库版本
- 所有表结构变更都通过迁移脚本进行

### 6.2 备份策略
- 每日全量备份
- 实时 WAL（Write-Ahead Logging）归档
- 保留最近30天的备份

## 7. 扩展性考虑

### 7.1 读写分离
- 主库用于写操作
- 从库用于读操作（查询、搜索）

### 7.2 分库分表
- 当数据量达到千万级别时，考虑按分类或时间分表
- 评论表可按文章ID进行分表

### 7.3 缓存策略
- 热门文章缓存到 Redis
- 用户会话存储在 Redis
- 搜索结果缓存
- 分类树结构缓存

## 8. 安全性设计

### 8.1 数据加密
- 密码使用 bcrypt 加密存储
- 敏感信息（如IP地址）可选择性加密

### 8.2 SQL注入防护
- 使用参数化查询
- 禁止直接拼接SQL语句

### 8.3 权限控制
- 数据库用户权限最小化原则
- 应用层和数据库层双重权限验证

