# 百科Web应用 - 系统架构设计文档

## 1. 架构概述

### 1.1 架构模式
采用前后端分离的微服务架构模式：
- **前端**: 单页应用（SPA），静态资源部署
- **后端**: RESTful API服务
- **数据库**: PostgreSQL主库 + Redis缓存
- **部署**: Docker容器化部署

### 1.2 架构原则
- **高可用**: 服务无状态设计，支持水平扩展
- **高性能**: 缓存策略、数据库优化、CDN加速
- **高安全**: 多层安全防护、权限控制
- **易维护**: 模块化设计、清晰的分层架构

## 2. 系统分层架构

### 2.1 整体分层

```
┌─────────────────────────────────────┐
│         表现层 (Presentation)       │
│  Vue 3 + Element Plus + Router     │
└─────────────────────────────────────┘
                  │
                  │ HTTP/HTTPS
                  ▼
┌─────────────────────────────────────┐
│         应用层 (Application)        │
│      Gin/Echo + Middleware          │
└─────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│         业务层 (Business)           │
│      Service Layer (业务逻辑)       │
└─────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│         数据层 (Data)               │
│   Repository + GORM + PostgreSQL    │
└─────────────────────────────────────┘
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
  ┌──────────┐        ┌──────────┐
  │PostgreSQL│        │  Redis   │
  └──────────┘        └──────────┘
```

### 2.2 前端架构

#### 2.2.1 目录结构
```
frontend/
├── src/
│   ├── api/              # API接口封装
│   │   ├── request.ts    # Axios配置
│   │   ├── user.ts       # 用户相关API
│   │   ├── article.ts    # 文章相关API
│   │   └── comment.ts    # 评论相关API
│   ├── components/       # 公共组件
│   │   ├── common/       # 通用组件
│   │   ├── article/      # 文章相关组件
│   │   └── comment/      # 评论相关组件
│   ├── views/            # 页面视图
│   │   ├── Home.vue
│   │   ├── Article/
│   │   ├── User/
│   │   └── Admin/
│   ├── stores/           # Pinia状态管理
│   │   ├── user.ts
│   │   ├── article.ts
│   │   └── app.ts
│   ├── router/           # 路由配置
│   │   └── index.ts
│   ├── utils/            # 工具函数
│   │   ├── auth.ts
│   │   ├── format.ts
│   │   └── validate.ts
│   ├── assets/           # 静态资源
│   ├── styles/           # 样式文件
│   ├── App.vue
│   └── main.ts
├── public/
└── package.json
```

#### 2.2.2 状态管理设计
使用Pinia进行状态管理，主要Store：

- **userStore**: 用户信息、登录状态
- **articleStore**: 文章列表、当前文章
- **commentStore**: 评论数据
- **appStore**: 全局配置、主题、语言

#### 2.2.3 路由设计
```javascript
/                    # 首页
/article/:id         # 文章详情
/article/:id/edit    # 编辑文章
/article/new         # 创建文章
/category/:slug      # 分类页面
/tag/:slug           # 标签页面
/user/:id            # 用户主页
/user/:id/articles   # 用户文章列表
/login               # 登录
/register            # 注册
/admin               # 管理后台
/search              # 搜索页面
```

### 2.3 后端架构

#### 2.3.1 目录结构
```
backend/
├── cmd/
│   └── api/
│       └── main.go          # 应用入口
├── internal/
│   ├── handler/             # HTTP处理器
│   │   ├── user.go
│   │   ├── article.go
│   │   ├── comment.go
│   │   └── auth.go
│   ├── service/             # 业务逻辑层
│   │   ├── user_service.go
│   │   ├── article_service.go
│   │   └── comment_service.go
│   ├── repository/          # 数据访问层
│   │   ├── user_repo.go
│   │   ├── article_repo.go
│   │   └── comment_repo.go
│   ├── model/               # 数据模型
│   │   ├── user.go
│   │   ├── article.go
│   │   └── comment.go
│   ├── middleware/          # 中间件
│   │   ├── auth.go
│   │   ├── cors.go
│   │   ├── logger.go
│   │   └── rate_limit.go
│   ├── config/              # 配置管理
│   │   └── config.go
│   └── utils/               # 工具函数
│       ├── jwt.go
│       ├── password.go
│       └── validator.go
├── pkg/                     # 公共包
│   ├── logger/
│   ├── cache/
│   └── errors/
├── migrations/              # 数据库迁移
├── go.mod
└── go.sum
```

#### 2.3.2 分层职责

**Handler层（处理器层）**
- 接收HTTP请求
- 参数验证和绑定
- 调用Service层
- 返回HTTP响应

**Service层（业务逻辑层）**
- 实现业务逻辑
- 事务管理
- 调用Repository层
- 缓存管理

**Repository层（数据访问层）**
- 数据库操作
- SQL查询
- 数据映射

**Model层（数据模型层）**
- 定义数据结构
- 数据库表映射
- 验证规则

## 3. 数据流设计

### 3.1 请求处理流程

```
客户端请求
    │
    ▼
Nginx反向代理
    │
    ▼
中间件层 (CORS, Auth, Rate Limit, Logger)
    │
    ▼
路由分发
    │
    ▼
Handler层 (参数验证、绑定)
    │
    ▼
Service层 (业务逻辑、事务)
    │
    ▼
Repository层 (数据库操作)
    │
    ▼
PostgreSQL / Redis
    │
    ▼
响应返回
```

### 3.2 数据缓存策略

#### 3.2.1 缓存层级
1. **浏览器缓存**: 静态资源、API响应
2. **CDN缓存**: 静态文件、图片
3. **应用缓存**: Redis缓存热点数据
4. **数据库缓存**: PostgreSQL查询缓存

#### 3.2.2 缓存内容
- 用户信息（TTL: 1小时）
- 热门文章列表（TTL: 10分钟）
- 分类树结构（TTL: 1小时）
- 文章详情（TTL: 5分钟）
- 搜索结果（TTL: 5分钟）

#### 3.2.3 缓存更新策略
- **Write-Through**: 写入时同时更新缓存
- **Write-Back**: 写入时标记缓存失效
- **TTL过期**: 设置合理的过期时间
- **主动失效**: 数据更新时清除相关缓存

## 4. 安全架构

### 4.1 认证授权流程

```
用户登录
    │
    ▼
验证用户名密码
    │
    ▼
生成JWT Token (包含用户ID、角色)
    │
    ▼
返回Token给客户端
    │
    ▼
客户端存储Token (localStorage/cookie)
    │
    ▼
后续请求携带Token
    │
    ▼
中间件验证Token
    │
    ▼
提取用户信息，设置到Context
    │
    ▼
业务逻辑处理
```

### 4.2 权限控制

#### 4.2.1 角色定义
- **guest**: 游客（未登录）
- **user**: 普通用户
- **editor**: 编辑者（可编辑文章）
- **moderator**: 审核员（可审核内容）
- **admin**: 管理员（全权限）
- **sysadmin**: 系统管理员（最高权限）

#### 4.2.2 权限矩阵

| 功能 | guest | user | editor | moderator | admin | sysadmin |
|------|-------|------|--------|-----------|-------|----------|
| 查看文章 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 创建文章 | ✗ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 编辑文章 | ✗ | 自己 | ✓ | ✓ | ✓ | ✓ |
| 删除文章 | ✗ | ✗ | ✗ | ✓ | ✓ | ✓ |
| 审核内容 | ✗ | ✗ | ✗ | ✓ | ✓ | ✓ |
| 用户管理 | ✗ | ✗ | ✗ | ✗ | ✓ | ✓ |
| 系统配置 | ✗ | ✗ | ✗ | ✗ | ✗ | ✓ |

### 4.3 安全防护

#### 4.3.1 输入验证
- 前端验证（用户体验）
- 后端验证（安全保证）
- SQL注入防护（参数化查询）
- XSS防护（内容转义）

#### 4.3.2 接口安全
- Rate Limiting（防止暴力攻击）
- IP白名单/黑名单
- HTTPS强制
- CORS配置

#### 4.3.3 数据安全
- 密码加密（bcrypt）
- 敏感信息加密存储
- 操作日志记录
- 数据备份

## 5. 性能优化架构

### 5.1 前端性能优化

#### 5.1.1 代码优化
- 代码分割（Code Splitting）
- 路由懒加载
- 组件懒加载
- Tree Shaking

#### 5.1.2 资源优化
- 图片压缩和懒加载
- 静态资源CDN
- Gzip压缩
- 浏览器缓存

#### 5.1.3 运行时优化
- 虚拟滚动（长列表）
- 防抖节流
- 请求合并
- 状态缓存

### 5.2 后端性能优化

#### 5.2.1 数据库优化
- 索引优化
- 查询优化（避免N+1）
- 连接池配置
- 读写分离（扩展）

#### 5.2.2 缓存优化
- Redis缓存热点数据
- 查询结果缓存
- 缓存预热
- 缓存穿透防护

#### 5.2.3 并发优化
- Goroutine池
- 异步任务处理
- 批量操作
- 限流控制

## 6. 扩展性设计

### 6.1 水平扩展

#### 6.1.1 无状态设计
- 后端服务无状态
- Session存储在Redis
- 文件存储在对象存储

#### 6.1.2 负载均衡
- Nginx负载均衡
- 多实例部署
- 健康检查

### 6.2 数据库扩展

#### 6.2.1 读写分离
- 主库写操作
- 从库读操作
- 数据同步

#### 6.2.2 分库分表
- 按分类分表
- 按时间分表
- 分片策略

### 6.3 微服务拆分（未来）

```
当前单体架构
    │
    ▼
用户服务 (User Service)
文章服务 (Article Service)
评论服务 (Comment Service)
通知服务 (Notification Service)
搜索服务 (Search Service)
文件服务 (File Service)
```

## 7. 监控和日志

### 7.1 日志设计

#### 7.1.1 日志级别
- **DEBUG**: 调试信息
- **INFO**: 一般信息
- **WARN**: 警告信息
- **ERROR**: 错误信息
- **FATAL**: 严重错误

#### 7.1.2 日志内容
- 请求日志（请求路径、参数、响应时间）
- 错误日志（错误堆栈、上下文）
- 业务日志（关键操作）
- 审计日志（用户操作）

### 7.2 监控指标

#### 7.2.1 应用监控
- QPS（每秒请求数）
- 响应时间
- 错误率
- 并发数

#### 7.2.2 系统监控
- CPU使用率
- 内存使用率
- 磁盘IO
- 网络流量

#### 7.2.3 数据库监控
- 连接数
- 查询性能
- 慢查询
- 锁等待

## 8. 部署架构

### 8.1 开发环境
```
┌─────────────┐
│  开发机器    │
│             │
│  Vue Dev    │
│  Go Dev     │
│  PostgreSQL │
│  Redis      │
└─────────────┘
```

### 8.2 生产环境
```
                    ┌─────────────┐
                    │   CDN/OSS   │
                    └─────────────┘
                           │
                    ┌──────┴──────┐
                    │             │
                    ▼             ▼
            ┌───────────┐  ┌───────────┐
            │  Nginx LB  │  │  Nginx LB  │
            └─────┬─────┘  └─────┬─────┘
                  │               │
        ┌─────────┴─────────┐     │
        │                   │     │
        ▼                   ▼     ▼
  ┌──────────┐      ┌──────────┐
  │ Go API 1 │      │ Go API 2 │
  └────┬─────┘      └────┬─────┘
       │                 │
       └────────┬────────┘
                │
        ┌───────┴───────┐
        │               │
        ▼               ▼
   ┌─────────┐    ┌─────────┐
   │PostgreSQL│    │  Redis  │
   │  Master  │    │ Cluster │
   └────┬─────┘    └─────────┘
        │
        ▼
   ┌─────────┐
   │PostgreSQL│
   │  Slave   │
   └─────────┘
```

## 9. 技术选型说明

### 9.1 前端技术选型理由

| 技术 | 选型理由 |
|------|---------|
| Vue 3 | 渐进式框架，学习曲线平缓，生态丰富 |
| Vite | 快速构建工具，开发体验好 |
| Element Plus | 成熟的UI组件库，文档完善 |
| Pinia | Vue 3官方推荐的状态管理 |
| Axios | 成熟的HTTP客户端 |

### 9.2 后端技术选型理由

| 技术 | 选型理由 |
|------|---------|
| Go | 高性能、并发友好、部署简单 |
| Gin | 轻量级、性能好、中间件丰富 |
| GORM | 功能完善的ORM，开发效率高 |
| PostgreSQL | 功能强大、支持JSON、全文搜索 |
| Redis | 高性能缓存、支持多种数据结构 |

## 10. 架构演进路线

### 阶段一：MVP（最小可行产品）
- 单体架构
- 基础功能实现
- 单机部署

### 阶段二：优化阶段
- 性能优化
- 缓存引入
- 负载均衡

### 阶段三：扩展阶段
- 读写分离
- 微服务拆分
- 分布式部署

### 阶段四：高级阶段
- 服务网格
- 容器编排（K8s）
- 自动化运维

