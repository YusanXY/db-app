# 百科Web应用 - 后端架构设计文档

## 1. 技术栈

### 1.1 核心框架
- **Go 1.21+**: 编程语言
- **Gin 1.9+**: Web框架
- **GORM 1.25+**: ORM框架
- **PostgreSQL 15+**: 主数据库
- **Redis 7+**: 缓存数据库

### 1.2 工具库
- **jwt-go**: JWT认证
- **bcrypt**: 密码加密
- **validator**: 参数验证
- **zap**: 日志库
- **viper**: 配置管理
- **cobra**: CLI工具

### 1.3 其他
- **golang-migrate**: 数据库迁移
- **swaggo/swag**: API文档生成
- **testify**: 测试框架

## 2. 项目结构

```
backend/
├── cmd/
│   └── api/
│       └── main.go              # 应用入口
├── internal/
│   ├── handler/                 # HTTP处理器层
│   │   ├── auth_handler.go
│   │   ├── user_handler.go
│   │   ├── article_handler.go
│   │   ├── comment_handler.go
│   │   ├── category_handler.go
│   │   ├── tag_handler.go
│   │   ├── file_handler.go
│   │   ├── search_handler.go
│   │   └── notification_handler.go
│   ├── repository/                 # 数据访问层
│   │   ├── article_image_repository.go
│   ├── service/                 # 业务逻辑层
│   │   ├── auth_service.go
│   │   ├── user_service.go
│   │   ├── article_service.go
│   │   ├── comment_service.go
│   │   ├── category_service.go
│   │   ├── tag_service.go
│   │   ├── file_service.go
│   │   ├── search_service.go
│   │   └── notification_service.go
│   ├── repository/              # 数据访问层
│   │   ├── user_repository.go
│   │   ├── article_repository.go
│   │   ├── comment_repository.go
│   │   ├── category_repository.go
│   │   ├── tag_repository.go
│   │   ├── file_repository.go
│   │   └── base_repository.go
│   ├── model/                   # 数据模型
│   │   ├── user.go
│   │   ├── article.go
│   │   ├── article_image.go
│   │   ├── comment.go
│   │   ├── category.go
│   │   ├── tag.go
│   │   ├── file.go
│   │   └── common.go
│   ├── middleware/              # 中间件
│   │   ├── auth.go
│   │   ├── cors.go
│   │   ├── logger.go
│   │   ├── rate_limit.go
│   │   └── recovery.go
│   ├── config/                   # 配置管理
│   │   └── config.go
│   ├── dto/                      # 数据传输对象
│   │   ├── request/
│   │   └── response/
│   ├── utils/                    # 工具函数
│   │   ├── jwt.go
│   │   ├── password.go
│   │   ├── validator.go
│   │   └── pagination.go
│   └── errors/                   # 错误定义
│       └── errors.go
├── pkg/                          # 公共包
│   ├── logger/
│   ├── cache/
│   └── database/
├── migrations/                   # 数据库迁移
│   ├── 000001_init.up.sql
│   └── 000001_init.down.sql
├── scripts/                      # 脚本
│   └── migrate.sh
├── go.mod
├── go.sum
├── .env.example
└── README.md
```

## 3. 核心模块设计

### 3.1 配置管理

#### 3.1.1 配置结构 (internal/config/config.go)
```go
package config

import (
    "github.com/spf13/viper"
)

type Config struct {
    Server   ServerConfig
    Database DatabaseConfig
    Redis    RedisConfig
    JWT      JWTConfig
    File     FileConfig
}

type ServerConfig struct {
    Port         string
    Mode         string // debug, release
    ReadTimeout  int
    WriteTimeout int
}

type DatabaseConfig struct {
    Host         string
    Port         int
    User         string
    Password     string
    DBName       string
    MaxOpenConns int
    MaxIdleConns int
}

type RedisConfig struct {
    Host     string
    Port     int
    Password string
    DB       int
}

type JWTConfig struct {
    Secret     string
    ExpiresIn  int // 秒
    RefreshIn  int // 秒
}

type FileConfig struct {
    UploadPath string
    MaxSize    int64 // 字节
    AllowedExt []string
}

func LoadConfig() (*Config, error) {
    viper.SetConfigName("config")
    viper.SetConfigType("yaml")
    viper.AddConfigPath(".")
    viper.AddConfigPath("./config")
    
    viper.SetEnvPrefix("APP")
    viper.AutomaticEnv()
    
    if err := viper.ReadInConfig(); err != nil {
        return nil, err
    }
    
    var config Config
    if err := viper.Unmarshal(&config); err != nil {
        return nil, err
    }
    
    return &config, nil
}
```

### 3.2 数据模型

#### 3.2.1 用户模型 (internal/model/user.go)
```go
package model

import (
    "time"
    "gorm.io/gorm"
)

type User struct {
    ID            uint64         `gorm:"primaryKey" json:"id"`
    Username      string         `gorm:"uniqueIndex;size:50;not null" json:"username"`
    Email         string         `gorm:"uniqueIndex;size:255;not null" json:"email"`
    PasswordHash  string         `gorm:"size:255;not null" json:"-"`
    Nickname      string         `gorm:"size:100" json:"nickname"`
    AvatarURL     string         `gorm:"size:500" json:"avatar_url"`
    Bio           string         `gorm:"type:text" json:"bio"`
    Role          string         `gorm:"size:20;not null;default:'user'" json:"role"`
    Status        string         `gorm:"size:20;not null;default:'active'" json:"status"`
    EmailVerified bool           `gorm:"default:false" json:"email_verified"`
    LastLoginAt   *time.Time     `json:"last_login_at"`
    CreatedAt     time.Time      `json:"created_at"`
    UpdatedAt     time.Time      `json:"updated_at"`
    DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
}

func (User) TableName() string {
    return "users"
}
```

#### 3.2.2 文章模型 (internal/model/article.go)
```go
package model

import (
    "time"
    "gorm.io/gorm"
)

type Article struct {
    ID            uint64         `gorm:"primaryKey" json:"id"`
    Title         string         `gorm:"size:500;not null" json:"title"`
    Slug          string         `gorm:"uniqueIndex;size:500;not null" json:"slug"`
    Content       string         `gorm:"type:text;not null" json:"content"`
    ContentHTML   string         `gorm:"type:text" json:"content_html"`
    Summary       string         `gorm:"type:text" json:"summary"`
    CoverImageURL string         `gorm:"size:500" json:"cover_image_url"`
    AuthorID      uint64         `gorm:"not null;index" json:"author_id"`
    EditorID      uint64         `gorm:"index" json:"editor_id"`
    Status        string         `gorm:"size:20;not null;default:'draft'" json:"status"`
    ViewCount     int            `gorm:"default:0" json:"view_count"`
    LikeCount     int            `gorm:"default:0" json:"like_count"`
    CommentCount  int            `gorm:"default:0" json:"comment_count"`
    EditCount     int            `gorm:"default:0" json:"edit_count"`
    IsFeatured    bool           `gorm:"default:false" json:"is_featured"`
    IsLocked      bool           `gorm:"default:false" json:"is_locked"`
    PublishedAt   *time.Time     `json:"published_at"`
    CreatedAt     time.Time      `json:"created_at"`
    UpdatedAt     time.Time      `json:"updated_at"`
    DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
    
    // 关联
    Author        User           `gorm:"foreignKey:AuthorID" json:"author"`
    Editor        *User          `gorm:"foreignKey:EditorID" json:"editor,omitempty"`
    Categories    []Category     `gorm:"many2many:article_categories;" json:"categories"`
    Tags          []Tag          `gorm:"many2many:article_tags;" json:"tags"`
}

func (Article) TableName() string {
    return "articles"
}
```

### 3.3 Repository层

#### 3.3.1 基础Repository (internal/repository/base_repository.go)
```go
package repository

import (
    "gorm.io/gorm"
)

type BaseRepository struct {
    db *gorm.DB
}

func NewBaseRepository(db *gorm.DB) *BaseRepository {
    return &BaseRepository{db: db}
}

func (r *BaseRepository) DB() *gorm.DB {
    return r.db
}

func (r *BaseRepository) Paginate(page, pageSize int) func(db *gorm.DB) *gorm.DB {
    return func(db *gorm.DB) *gorm.DB {
        offset := (page - 1) * pageSize
        return db.Offset(offset).Limit(pageSize)
    }
}
```

#### 3.3.2 文章Repository (internal/repository/article_repository.go)
```go
package repository

import (
    "dbapp/internal/model"
    "gorm.io/gorm"
)

type ArticleRepository struct {
    *BaseRepository
}

func NewArticleRepository(db *gorm.DB) *ArticleRepository {
    return &ArticleRepository{
        BaseRepository: NewBaseRepository(db),
    }
}

func (r *ArticleRepository) Create(article *model.Article) error {
    return r.db.Create(article).Error
}

func (r *ArticleRepository) GetByID(id uint64) (*model.Article, error) {
    var article model.Article
    err := r.db.Preload("Author").Preload("Editor").
        Preload("Categories").Preload("Tags").
        First(&article, id).Error
    return &article, err
}

func (r *ArticleRepository) GetBySlug(slug string) (*model.Article, error) {
    var article model.Article
    err := r.db.Where("slug = ?", slug).
        Preload("Author").Preload("Editor").
        Preload("Categories").Preload("Tags").
        First(&article).Error
    return &article, err
}

func (r *ArticleRepository) List(page, pageSize int, conditions map[string]interface{}) ([]model.Article, int64, error) {
    var articles []model.Article
    var total int64
    
    query := r.db.Model(&model.Article{})
    
    // 应用条件
    if status, ok := conditions["status"]; ok {
        query = query.Where("status = ?", status)
    }
    if categoryID, ok := conditions["category_id"]; ok {
        query = query.Joins("JOIN article_categories ON articles.id = article_categories.article_id").
            Where("article_categories.category_id = ?", categoryID)
    }
    
    // 统计总数
    if err := query.Count(&total).Error; err != nil {
        return nil, 0, err
    }
    
    // 分页查询
    err := query.Preload("Author").Preload("Categories").Preload("Tags").
        Scopes(r.Paginate(page, pageSize)).
        Order("created_at DESC").
        Find(&articles).Error
    
    return articles, total, err
}

func (r *ArticleRepository) Update(article *model.Article) error {
    return r.db.Save(article).Error
}

func (r *ArticleRepository) Delete(id uint64) error {
    return r.db.Delete(&model.Article{}, id).Error
}

func (r *ArticleRepository) IncrementViewCount(id uint64) error {
    return r.db.Model(&model.Article{}).Where("id = ?", id).
        UpdateColumn("view_count", gorm.Expr("view_count + 1")).Error
}
```

### 3.4 Service层

#### 3.4.1 文章Service (internal/service/article_service.go)
```go
package service

import (
    "dbapp/internal/dto/request"
    "dbapp/internal/dto/response"
    "dbapp/internal/model"
    "dbapp/internal/repository"
    "dbapp/pkg/errors"
    "github.com/gosimple/slug"
)

type ArticleService struct {
    articleRepo *repository.ArticleRepository
    userRepo    *repository.UserRepository
}

func NewArticleService(
    articleRepo *repository.ArticleRepository,
    userRepo *repository.UserRepository,
) *ArticleService {
    return &ArticleService{
        articleRepo: articleRepo,
        userRepo:    userRepo,
    }
}

func (s *ArticleService) Create(req *request.CreateArticleRequest, userID uint64) (*response.ArticleResponse, error) {
    // 生成slug
    articleSlug := slug.Make(req.Title)
    
    // 检查slug是否已存在
    existing, _ := s.articleRepo.GetBySlug(articleSlug)
    if existing != nil {
        return nil, errors.NewBadRequestError("文章标题已存在")
    }
    
    article := &model.Article{
        Title:   req.Title,
        Slug:    articleSlug,
        Content: req.Content,
        Summary: req.Summary,
        AuthorID: userID,
        Status:  req.Status,
    }
    
    if err := s.articleRepo.Create(article); err != nil {
        return nil, err
    }
    
    return s.toResponse(article), nil
}

func (s *ArticleService) GetByID(id uint64) (*response.ArticleResponse, error) {
    article, err := s.articleRepo.GetByID(id)
    if err != nil {
        return nil, errors.NewNotFoundError("文章不存在")
    }
    
    // 增加浏览次数
    go s.articleRepo.IncrementViewCount(id)
    
    return s.toResponse(article), nil
}

func (s *ArticleService) List(req *request.ListArticleRequest) (*response.ArticleListResponse, error) {
    conditions := make(map[string]interface{})
    if req.Status != "" {
        conditions["status"] = req.Status
    }
    if req.CategoryID > 0 {
        conditions["category_id"] = req.CategoryID
    }
    
    articles, total, err := s.articleRepo.List(req.Page, req.PageSize, conditions)
    if err != nil {
        return nil, err
    }
    
    items := make([]*response.ArticleResponse, len(articles))
    for i, article := range articles {
        items[i] = s.toResponse(&article)
    }
    
    return &response.ArticleListResponse{
        Items: items,
        Pagination: response.Pagination{
            Page:       req.Page,
            PageSize:   req.PageSize,
            Total:      total,
            TotalPages: int((total + int64(req.PageSize) - 1) / int64(req.PageSize)),
        },
    }, nil
}

func (s *ArticleService) toResponse(article *model.Article) *response.ArticleResponse {
    return &response.ArticleResponse{
        ID:            article.ID,
        Title:         article.Title,
        Slug:          article.Slug,
        Content:       article.Content,
        ContentHTML:   article.ContentHTML,
        Summary:       article.Summary,
        CoverImageURL: article.CoverImageURL,
        Author:        s.userToResponse(&article.Author),
        ViewCount:     article.ViewCount,
        LikeCount:     article.LikeCount,
        CommentCount:  article.CommentCount,
        IsFeatured:    article.IsFeatured,
        Status:        article.Status,
        CreatedAt:     article.CreatedAt,
        UpdatedAt:     article.UpdatedAt,
    }
}

func (s *ArticleService) userToResponse(user *model.User) *response.UserResponse {
    return &response.UserResponse{
        ID:        user.ID,
        Username:  user.Username,
        Nickname:  user.Nickname,
        AvatarURL: user.AvatarURL,
    }
}
```

### 3.5 Handler层

#### 3.5.1 文章Handler (internal/handler/article_handler.go)
```go
package handler

import (
    "dbapp/internal/dto/request"
    "dbapp/internal/service"
    "dbapp/pkg/errors"
    "github.com/gin-gonic/gin"
    "strconv"
)

type ArticleHandler struct {
    articleService *service.ArticleService
}

func NewArticleHandler(articleService *service.ArticleService) *ArticleHandler {
    return &ArticleHandler{
        articleService: articleService,
    }
}

// GetArticleList 获取文章列表
// @Summary 获取文章列表
// @Tags 文章
// @Accept json
// @Produce json
// @Param page query int false "页码" default(1)
// @Param page_size query int false "每页数量" default(20)
// @Param status query string false "状态"
// @Param category_id query int false "分类ID"
// @Success 200 {object} response.ArticleListResponse
// @Router /api/v1/articles [get]
func (h *ArticleHandler) GetArticleList(c *gin.Context) {
    var req request.ListArticleRequest
    if err := c.ShouldBindQuery(&req); err != nil {
        errors.HandleError(c, errors.NewBadRequestError("参数错误"))
        return
    }
    
    if req.Page <= 0 {
        req.Page = 1
    }
    if req.PageSize <= 0 {
        req.PageSize = 20
    }
    
    result, err := h.articleService.List(&req)
    if err != nil {
        errors.HandleError(c, err)
        return
    }
    
    c.JSON(200, gin.H{
        "code": 200,
        "data": result,
    })
}

// GetArticleDetail 获取文章详情
// @Summary 获取文章详情
// @Tags 文章
// @Accept json
// @Produce json
// @Param id path int true "文章ID"
// @Success 200 {object} response.ArticleResponse
// @Router /api/v1/articles/{id} [get]
func (h *ArticleHandler) GetArticleDetail(c *gin.Context) {
    id, err := strconv.ParseUint(c.Param("id"), 10, 64)
    if err != nil {
        errors.HandleError(c, errors.NewBadRequestError("无效的文章ID"))
        return
    }
    
    article, err := h.articleService.GetByID(id)
    if err != nil {
        errors.HandleError(c, err)
        return
    }
    
    c.JSON(200, gin.H{
        "code": 200,
        "data": article,
    })
}

// CreateArticle 创建文章
// @Summary 创建文章
// @Tags 文章
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param article body request.CreateArticleRequest true "文章信息"
// @Success 201 {object} response.ArticleResponse
// @Router /api/v1/articles [post]
func (h *ArticleHandler) CreateArticle(c *gin.Context) {
    var req request.CreateArticleRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        errors.HandleError(c, errors.NewBadRequestError("参数错误"))
        return
    }
    
    userID := c.GetUint64("user_id")
    
    article, err := h.articleService.Create(&req, userID)
    if err != nil {
        errors.HandleError(c, err)
        return
    }
    
    c.JSON(201, gin.H{
        "code":    201,
        "message": "创建成功",
        "data":    article,
    })
}
```

### 3.6 中间件

#### 3.6.1 认证中间件 (internal/middleware/auth.go)
```go
package middleware

import (
    "dbapp/pkg/utils"
    "dbapp/pkg/errors"
    "github.com/gin-gonic/gin"
    "strings"
)

func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        authHeader := c.GetHeader("Authorization")
        if authHeader == "" {
            errors.HandleError(c, errors.NewUnauthorizedError("未提供认证信息"))
            c.Abort()
            return
        }
        
        parts := strings.SplitN(authHeader, " ", 2)
        if len(parts) != 2 || parts[0] != "Bearer" {
            errors.HandleError(c, errors.NewUnauthorizedError("认证格式错误"))
            c.Abort()
            return
        }
        
        token := parts[1]
        claims, err := utils.ParseJWT(token)
        if err != nil {
            errors.HandleError(c, errors.NewUnauthorizedError("Token无效或已过期"))
            c.Abort()
            return
        }
        
        c.Set("user_id", claims.UserID)
        c.Set("username", claims.Username)
        c.Set("role", claims.Role)
        
        c.Next()
    }
}
```

#### 3.6.2 限流中间件 (internal/middleware/rate_limit.go)
```go
package middleware

import (
    "dbapp/pkg/cache"
    "github.com/gin-gonic/gin"
    "strconv"
    "time"
)

func RateLimitMiddleware(limit int, window time.Duration) gin.HandlerFunc {
    return func(c *gin.Context) {
        key := "rate_limit:" + c.ClientIP() + ":" + c.Request.URL.Path
        
        count, err := cache.GetInt(key)
        if err != nil || count == 0 {
            cache.Set(key, 1, window)
            c.Next()
            return
        }
        
        if count >= limit {
            c.JSON(429, gin.H{
                "code": 429,
                "message": "请求过于频繁，请稍后再试",
                "retry_after": int(window.Seconds()),
            })
            c.Abort()
            return
        }
        
        cache.Increment(key)
        c.Next()
    }
}
```

### 3.7 应用入口

#### 3.7.1 main.go (cmd/api/main.go)
```go
package main

import (
    "dbapp/internal/config"
    "dbapp/internal/handler"
    "dbapp/internal/middleware"
    "dbapp/internal/repository"
    "dbapp/internal/service"
    "dbapp/pkg/database"
    "dbapp/pkg/logger"
    "github.com/gin-gonic/gin"
)

func main() {
    // 加载配置
    cfg, err := config.LoadConfig()
    if err != nil {
        panic(err)
    }
    
    // 初始化日志
    logger.Init(cfg.Server.Mode)
    
    // 初始化数据库
    db, err := database.InitPostgreSQL(cfg.Database)
    if err != nil {
        panic(err)
    }
    
    // 初始化Redis
    redisClient, err := database.InitRedis(cfg.Redis)
    if err != nil {
        panic(err)
    }
    
    // 初始化Repository
    userRepo := repository.NewUserRepository(db)
    articleRepo := repository.NewArticleRepository(db)
    
    // 初始化Service
    userService := service.NewUserService(userRepo)
    articleService := service.NewArticleService(articleRepo, userRepo)
    
    // 初始化Handler
    authHandler := handler.NewAuthHandler(userService)
    articleHandler := handler.NewArticleHandler(articleService)
    
    // 初始化路由
    router := gin.Default()
    
    // 中间件
    router.Use(middleware.CORSMiddleware())
    router.Use(middleware.LoggerMiddleware())
    router.Use(middleware.RecoveryMiddleware())
    
    // API路由
    api := router.Group("/api/v1")
    {
        // 认证路由
        auth := api.Group("/auth")
        {
            auth.POST("/register", authHandler.Register)
            auth.POST("/login", authHandler.Login)
            auth.GET("/me", middleware.AuthMiddleware(), authHandler.GetMe)
        }
        
        // 文章路由
        articles := api.Group("/articles")
        {
            articles.GET("", articleHandler.GetArticleList)
            articles.GET("/:id", articleHandler.GetArticleDetail)
            articles.POST("", middleware.AuthMiddleware(), articleHandler.CreateArticle)
            articles.PUT("/:id", middleware.AuthMiddleware(), articleHandler.UpdateArticle)
            articles.DELETE("/:id", middleware.AuthMiddleware(), articleHandler.DeleteArticle)
        }
    }
    
    // 启动服务
    if err := router.Run(":" + cfg.Server.Port); err != nil {
        panic(err)
    }
}
```

## 4. 错误处理

### 4.1 错误定义 (internal/errors/errors.go)
```go
package errors

import (
    "fmt"
    "github.com/gin-gonic/gin"
)

type AppError struct {
    Code    int
    Message string
    Err     error
}

func (e *AppError) Error() string {
    if e.Err != nil {
        return fmt.Sprintf("%s: %v", e.Message, e.Err)
    }
    return e.Message
}

func NewBadRequestError(message string) *AppError {
    return &AppError{Code: 400, Message: message}
}

func NewUnauthorizedError(message string) *AppError {
    return &AppError{Code: 401, Message: message}
}

func NewForbiddenError(message string) *AppError {
    return &AppError{Code: 403, Message: message}
}

func NewNotFoundError(message string) *AppError {
    return &AppError{Code: 404, Message: message}
}

func HandleError(c *gin.Context, err error) {
    if appErr, ok := err.(*AppError); ok {
        c.JSON(appErr.Code, gin.H{
            "code":    appErr.Code,
            "message": appErr.Message,
        })
    } else {
        c.JSON(500, gin.H{
            "code":    500,
            "message": "服务器内部错误",
        })
    }
}
```

## 5. 数据库迁移

### 5.1 迁移脚本示例
使用golang-migrate进行数据库迁移管理。

## 6. 测试

### 6.1 单元测试
- Service层测试
- Repository层测试
- 工具函数测试

### 6.2 集成测试
- API接口测试
- 数据库操作测试

## 7. 部署

### 7.1 构建
```bash
go build -o bin/api cmd/api/main.go
```

### 7.2 运行
```bash
./bin/api
```

### 7.3 Docker部署
参考容器化部署指南。

