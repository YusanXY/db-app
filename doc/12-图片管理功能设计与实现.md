# 图片管理功能设计与实现文档

## 1. 功能概述

本文档详细介绍了百科Web应用中图片管理功能的设计与实现，包括：
- 图片上传功能
- 文章图片自动提取和管理
- 图片数据库设计
- 前后端实现细节

## 2. 数据库设计

### 2.1 文章图片表 (article_images)

**表名**: `article_images`

**设计目的**:
- 追踪文章内容中使用的所有图片
- 便于后续的图片管理和清理
- 支持图片使用统计

**表结构**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 图片记录ID |
| article_id | BIGINT | NOT NULL, FK -> articles(id) | 文章ID |
| image_url | VARCHAR(500) | NOT NULL | 图片URL（相对路径或绝对路径） |
| image_path | VARCHAR(500) | | 服务器上的文件路径 |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| mime_type | VARCHAR(100) | | MIME类型（如 image/jpeg） |
| width | INTEGER | | 图片宽度（像素） |
| height | INTEGER | | 图片高度（像素） |
| alt | VARCHAR(500) | | 图片描述（Alt文本） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMP | | 软删除时间 |

**索引**:
- `idx_article_images_article_id` ON article_images(article_id)
- `idx_article_images_image_url` ON article_images(image_url)
- `idx_article_images_deleted_at` ON article_images(deleted_at)

**外键约束**:
- `article_id` -> `articles(id)` ON DELETE CASCADE

**设计说明**:
1. **软删除支持**: 使用`deleted_at`字段实现软删除，便于数据恢复和审计
2. **图片URL存储**: 支持相对路径（如`/uploads/filename.jpg`）和绝对路径（如`https://...`）
3. **元数据存储**: 存储图片的尺寸、大小、类型等元数据，便于后续优化和管理
4. **Alt文本**: 存储图片的Alt文本，提升可访问性

### 2.2 数据库关系

```
articles (1) ──< (N) article_images
```

- 一篇文章可以包含多张图片
- 图片记录与文章关联，文章删除时图片记录也会被软删除

## 3. 后端实现

### 3.1 数据模型

**文件位置**: `backend/internal/model/article_image.go`

```go
type ArticleImage struct {
    ID        uint64         `gorm:"primaryKey" json:"id"`
    ArticleID uint64         `gorm:"not null;index" json:"article_id"`
    ImageURL  string         `gorm:"size:500;not null" json:"image_url"`
    ImagePath string         `gorm:"size:500" json:"image_path"`
    FileSize  int64          `gorm:"default:0" json:"file_size"`
    MimeType  string         `gorm:"size:100" json:"mime_type"`
    Width     int            `json:"width"`
    Height    int            `json:"height"`
    Alt       string         `gorm:"size:500" json:"alt"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`
    
    Article Article `gorm:"foreignKey:ArticleID" json:"article,omitempty"`
}
```

### 3.2 Repository层

**文件位置**: `backend/internal/repository/article_image_repository.go`

**主要方法**:
- `Create(image *model.ArticleImage) error` - 创建图片记录
- `GetByArticleID(articleID uint64) ([]*model.ArticleImage, error)` - 获取文章的所有图片
- `GetByURL(url string) (*model.ArticleImage, error)` - 根据URL获取图片记录
- `DeleteByArticleID(articleID uint64) error` - 删除文章的所有图片记录（软删除）
- `DeleteByID(id uint64) error` - 删除指定图片记录
- `CountByArticleID(articleID uint64) (int64, error)` - 统计文章使用的图片数量

### 3.3 Service层 - 图片提取逻辑

**文件位置**: `backend/internal/service/article_service.go`

**核心方法**: `extractAndSaveImages(articleID uint64, content string)`

**功能**:
1. 从Markdown内容中提取图片URL
2. 支持两种格式：
   - Markdown格式: `![alt](url)`
   - HTML格式: `<img src="url" alt="alt" />`
3. 只处理相对路径的图片（上传到服务器的图片）
4. 自动创建新的图片记录
5. 清理不再使用的图片记录（软删除）

**实现逻辑**:
```go
// 1. 使用正则表达式匹配图片URL
imgRegex := regexp.MustCompile(`!\[([^\]]*)\]\(([^)]+)\)|<img[^>]+src=["']([^"']+)["'][^>]*>`)

// 2. 收集所有图片URL
imageURLs := make(map[string]bool)
for _, match := range matches {
    // 提取URL
    // 过滤外部链接（http://, https://）
    // 只处理相对路径
}

// 3. 获取现有的图片记录
existingImages, _ := s.articleImageRepo.GetByArticleID(articleID)

// 4. 添加新图片
for url := range imageURLs {
    if !existingURLs[url] {
        // 检查是否已存在（可能其他文章也在使用）
        existing, _ := s.articleImageRepo.GetByURL(url)
        if existing == nil {
            // 创建新记录
            articleImage := &model.ArticleImage{
                ArticleID: articleID,
                ImageURL:  url,
            }
            s.articleImageRepo.Create(articleImage)
        }
    }
}

// 5. 删除不再使用的图片记录（软删除）
for _, img := range existingImages {
    if !imageURLs[img.ImageURL] {
        s.articleImageRepo.DeleteByID(img.ID)
    }
}
```

**调用时机**:
- 创建文章时：`Create()` 方法中调用
- 更新文章时：`Update()` 方法中，当内容更新时调用

### 3.4 文件上传Handler

**文件位置**: `backend/internal/handler/file_handler.go`

**接口**: `POST /api/v1/files/upload`

**功能**:
1. 接收文件上传请求（multipart/form-data）
2. 验证文件类型（jpg, jpeg, png, gif, webp）
3. 验证文件大小（最大10MB，可配置）
4. 生成唯一文件名：`{timestamp}_{原始文件名}`
5. 保存文件到服务器：`./uploads/` 目录
6. 返回文件URL：`/uploads/{filename}`

**配置**:
```go
type FileConfig struct {
    UploadPath string   // 上传目录路径
    MaxSize    int64    // 最大文件大小（字节）
    AllowedExt []string // 允许的文件扩展名
}
```

**错误处理**:
- `400`: 文件大小超限、文件类型不支持、未选择文件
- `401`: 未认证
- `500`: 服务器错误（创建目录失败、保存文件失败等）

### 3.5 静态文件服务

**文件位置**: `backend/cmd/api/main.go`

**配置**:
```go
// 静态文件服务（用于访问上传的文件）
uploadPath := cfg.File.UploadPath
if uploadPath == "" {
    uploadPath = "./uploads"
}
router.Static("/uploads", uploadPath)
```

**说明**:
- 通过Gin的静态文件服务提供文件访问
- 路径：`/uploads/*` 映射到服务器上的 `./uploads/` 目录
- 前端通过Nginx代理访问：`http://localhost/uploads/filename.jpg`

### 3.6 默认封面图片

**实现方式**:
- 在Docker构建时，将默认图片复制到容器中
- 路径：`/app/uploads/default/cover-default.jpg`
- 前端创建文章时，默认使用该图片作为封面

**Dockerfile配置**:
```dockerfile
# 创建uploads目录并复制默认图片
RUN mkdir -p /app/uploads/default
COPY backend/uploads/default/cover-default.jpg /app/uploads/default/cover-default.jpg
```

## 4. 前端实现

### 4.1 Markdown编辑器图片上传

**文件位置**: `frontend/src/components/MarkdownEditor.vue`

**功能特性**:
1. **拖拽上传**: 支持直接拖拽图片文件到编辑器
2. **复制粘贴**: 支持从剪贴板粘贴图片（Ctrl+V）
3. **工具栏上传**: 通过vditor工具栏的图片按钮上传

**实现方式**:

#### 4.1.1 vditor配置
```typescript
upload: {
  accept: 'image/*',
  url: '/api/v1/files/upload',
  fieldName: 'file',
  headers: {
    Authorization: `Bearer ${token}`
  },
  format: (files: File[], responseText: string) => {
    // 解析响应，返回图片URL数组
    const res = JSON.parse(responseText)
    if (res.code === 200 && res.data) {
      return JSON.stringify([res.data.url])
    }
    return '[]'
  }
}
```

#### 4.1.2 粘贴图片处理
```typescript
const handlePaste = async (e: ClipboardEvent) => {
  const items = e.clipboardData?.items
  if (!items || !vditor) return
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i]
    if (item.type.indexOf('image') !== -1) {
      e.preventDefault()
      e.stopPropagation()
      const file = item.getAsFile()
      if (file) {
        // 上传图片
        const formData = new FormData()
        formData.append('file', file)
        
        const response = await fetch('/api/v1/files/upload', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        })
        
        const result = await response.json()
        if (result.code === 200 && result.data) {
          // 插入图片到编辑器
          const imageUrl = result.data.url
          const markdown = `![${file.name}](${imageUrl})`
          vditor.insertValue(markdown)
        }
      }
      break
    }
  }
}
```

### 4.2 封面图片上传

**文件位置**: `frontend/src/views/Article/Create.vue`

**功能特性**:
1. 使用Element Plus的`el-upload`组件
2. 支持图片预览
3. 支持删除封面图片（恢复为默认图片）
4. 默认使用测试图片：`/uploads/default/cover-default.jpg`

**实现**:
```vue
<el-upload
  class="cover-uploader"
  :action="uploadAction"
  :headers="uploadHeaders"
  :show-file-list="false"
  :on-success="handleCoverSuccess"
  :before-upload="beforeCoverUpload"
  accept="image/*"
>
  <img v-if="form.cover_image_url" :src="form.cover_image_url" class="cover-image" />
  <el-icon v-else class="cover-uploader-icon"><Plus /></el-icon>
</el-upload>
```

### 4.3 图片显示

**文件位置**:
- `frontend/src/views/Article/Detail.vue` - 文章详情页封面图片
- `frontend/src/views/Home.vue` - 首页文章列表缩略图

**实现**:
```vue
<!-- 封面图片 -->
<div v-if="article.cover_image_url" class="article-cover">
  <img :src="article.cover_image_url" :alt="article.title" />
</div>

<!-- 列表缩略图 -->
<div v-if="article.cover_image_url" class="article-cover-thumbnail">
  <img :src="article.cover_image_url" :alt="article.title" />
</div>
```

## 5. Nginx配置

**文件位置**: `nginx/nginx.conf`

**配置**:
```nginx
# 文件上传
location /uploads/ {
    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
}
```

**说明**:
- 前端通过Nginx代理访问后端静态文件服务
- 路径：`/uploads/*` 代理到后端 `http://backend:8080/uploads/*`

## 6. 工作流程

### 6.1 图片上传流程

1. **用户操作**:
   - 在Markdown编辑器中拖拽图片、粘贴图片或点击工具栏上传
   - 或在上传封面图片时选择文件

2. **前端处理**:
   - 创建FormData，添加文件
   - 添加Authorization头（JWT token）
   - 发送POST请求到 `/api/v1/files/upload`

3. **后端处理**:
   - 验证文件类型和大小
   - 生成唯一文件名
   - 保存文件到服务器
   - 返回文件URL

4. **前端接收**:
   - 解析响应，获取文件URL
   - 插入到Markdown编辑器或更新封面图片URL

### 6.2 图片自动提取流程

1. **文章创建/更新**:
   - 用户提交文章内容（包含Markdown格式的图片）
   - 后端接收请求，保存文章

2. **图片提取**:
   - 调用`extractAndSaveImages()`方法
   - 使用正则表达式匹配图片URL
   - 过滤外部链接，只处理相对路径

3. **图片记录管理**:
   - 获取现有的图片记录
   - 添加新图片记录
   - 软删除不再使用的图片记录

4. **数据库更新**:
   - 新图片记录插入到`article_images`表
   - 旧图片记录标记为软删除（`deleted_at`字段）

## 7. 配置说明

### 7.1 后端配置

**文件位置**: `backend/internal/config/config.go`

```go
type FileConfig struct {
    UploadPath string   `mapstructure:"upload_path"` // 默认: "./uploads"
    MaxSize    int64    `mapstructure:"max_size"`     // 默认: 10MB
    AllowedExt []string `mapstructure:"allowed_ext"`  // 默认: ["jpg", "jpeg", "png", "gif", "webp"]
}
```

### 7.2 环境变量

可以通过环境变量或配置文件修改：
- `FILE_UPLOAD_PATH`: 上传目录路径
- `FILE_MAX_SIZE`: 最大文件大小（字节）
- `FILE_ALLOWED_EXT`: 允许的文件扩展名（逗号分隔）

## 8. 安全考虑

### 8.1 文件类型验证
- 白名单机制：只允许指定的文件类型
- 文件扩展名检查
- MIME类型验证（可选）

### 8.2 文件大小限制
- 限制单个文件大小（默认10MB）
- 防止恶意上传大文件导致服务器资源耗尽

### 8.3 文件命名
- 使用时间戳+原始文件名，避免文件名冲突
- 防止路径遍历攻击（文件名中不包含`../`等）

### 8.4 访问控制
- 文件上传需要JWT认证
- 静态文件服务可以公开访问（或根据需要添加访问控制）

### 8.5 存储安全
- 文件存储在服务器本地文件系统
- 可以考虑使用对象存储（OSS、S3等）提高安全性和可扩展性

## 9. 性能优化

### 9.1 图片压缩
- 建议在上传时自动压缩大图片
- 可以使用Go的图片处理库（如`imaging`）进行压缩

### 9.2 CDN支持
- 可以将图片上传到CDN或对象存储
- 提高图片访问速度
- 减轻服务器负载

### 9.3 图片懒加载
- 前端可以实现图片懒加载
- 减少初始页面加载时间

### 9.4 缓存策略
- 静态文件可以设置缓存头
- 减少重复请求

## 10. 后续优化建议

### 10.1 图片管理界面
- 实现图片列表查询
- 支持图片删除
- 显示图片使用情况统计

### 10.2 图片处理
- 自动生成缩略图
- 支持图片裁剪、旋转等操作
- 支持多种图片格式转换

### 10.3 图片搜索
- 支持按文件名、上传时间等搜索
- 支持按文章关联搜索

### 10.4 图片统计
- 统计图片使用次数
- 识别未使用的图片
- 提供图片清理建议

### 10.5 对象存储集成
- 支持阿里云OSS、AWS S3等对象存储
- 支持图片CDN加速
- 提高图片访问速度和可靠性

## 11. 测试建议

### 11.1 功能测试
- 测试图片上传（拖拽、粘贴、工具栏）
- 测试文件类型验证
- 测试文件大小限制
- 测试图片自动提取
- 测试图片记录管理（创建、删除）

### 11.2 性能测试
- 测试大文件上传性能
- 测试并发上传性能
- 测试图片提取性能

### 11.3 安全测试
- 测试文件类型绕过
- 测试文件大小绕过
- 测试路径遍历攻击
- 测试未授权访问

### 11.4 兼容性测试
- 测试不同浏览器的图片上传
- 测试不同图片格式的支持
- 测试移动端的图片上传

## 12. 总结

图片管理功能已经完整实现，包括：
- ✅ 图片上传功能（拖拽、粘贴、工具栏）
- ✅ 文件类型和大小验证
- ✅ 静态文件服务
- ✅ 文章图片自动提取和管理
- ✅ 数据库记录管理
- ✅ 默认封面图片支持

该功能为文章创作提供了完整的图片支持，同时为后续的图片管理和优化奠定了基础。

